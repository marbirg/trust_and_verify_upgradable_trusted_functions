# Requirements
To be able to run the examples it is necessary to have access to an Intel SGX capable machine, as well as having Gramine installed. The following hardware specifications has been used in Azure cloud during development:

|Property  |Value|
|----------|-----|
|OS/Kernel | Linux SGX 5.4.0-1104-azure \#110$ ~18.04.1-Ubuntu SMP x86\_64 GNU/Linux |
|CPU | Intel(R) Xeon(R) E-2288G CPU @ 3.70GHz |
|Size | Standard DC2ds v3 |
|vCPUs | 2 |
|RAM | 16\,GiB|

Installation options for Gramine can be found here: https://gramine.readthedocs.io/en/stable/installation.html

On an Ubuntu system one could also run ``install-gramine.sh``.

# Setup
## 1. Initiate system:
To fetch Dafny version 4.6.0 (used during development), run ``make setup``. This will also setup the required folders, create a python virtual environment (used when running outside the enclave), as well as installing python packages to the virtual environment and generating SSL certificates.

The enclave does not use a virtual environment, but imports the python packages that are installed on the host system. Hence the packages specified in ``requirements.txt`` must manually be installed on the host, or the ``python.manifest.template`` must be updated to import packages from the virtual environment instead.

Alternative Dafny:
If another version of Dafny should be used, it can be fetched from: https://github.com/dafny-lang/dafny/releases

Unzip the file to a folder called "dafny" in the root directory.

## 2. Build
To build the Gramine manifests, run ``make build``. This will generate the manifest as well as the signature.

# Run
The application can be run either as indended inside the enclave using ``make run-enclave`` or as a pure Python app (faster and good for finding bugs during development) with ``make run-local``. When running local automatic reload is enabled, something that does not work well inside the enclave.

When the application is running, two different test cases is available in ``examples``:
``deploy_faulty_voting.py`` starts by deploying a correct voting implementation and verifies that this is accepted. It then tries to deploy an implementation that does not fulfill the function specification and verifies that this is rejected.

``update_sorting.py`` deploys two different sorting algoriths and verifies that both are accepted.

# Folder and files
``python.manifest.template`` describes the enclave for gramine.
This file is the base and used to generate pyhon.manifest, python.manifest.sgx and python.sig. These files should not be manually edited.

``scripts/`` contains the files for the main application.

``analytics/`` contains benchmarking scripts and files from dafnybench.

``templates/`` contains the function specifications.

## Generated files and folders
``data/`` is generated by the enclave and used as the sealed file system.

``make setup`` generates ``local/`` which is used as the file storage when running the bare python application outside the enclave. The setup command also generates ssl certificates in ``local/ssl``.
In addition, this command generates ``input/`` wich can be used during development to feed Dafny implementations to the enclave application without going via the http api.